# XPOS Data Format

version 0.1.1

## <a id="sec-1"></a> 1. Abstract - 概要

この文書は、高い移植性を持ち、大きな仕様上のキャパシティを持つデータ交換用の形式であるXPOSのフォーマットの定義を行う。

### <a id="sec-1-1"></a> 1.1. Status - 本書の位置づけ

本書は、インターネットコミュニティへの情報提供のためのものであり、標準を構成するものではない。
本書の配布は無制限である。

### <a id="sec-1-2"></a> 1.2. Index - 目次

-	[1 概要](#sec-1)
	-	[1.1 本書の位置づけ](#sec-1-1)
	-	[1.2 目次](#sec-1-2)
-	[2 用語と頭字語](#sec-2)
-	[3 プリミティブ型とオブジェクト](#sec-3)
	-	[3.1 整数型](#sec-3-1)
	-	[3.2 バイナリ型](#sec-3-2)
	-	[3.3 文字列型](#sec-3-3)
	-	[3.4 実数型](#sec-3-4)
	-	[3.5 コレクション型](#sec-3-5)
	-	[3.6 名前](#sec-3-6)
	-	[3.7 拡張オブジェクト](#sec-3-7)
-	[4 XPOS タグフォーマット](#sec-4)
	-	[4.1 タグ内部構造](#sec-4-1)
		-	[4.1.1 単一ワードタグ](#sec-4-1-1)
		-	[4.1.2 単一ワード長タグ](#sec-4-1-2)
		-	[4.1.3 多倍ワード長タグ](#sec-4-1-3)
	-	[4.2 識別子](#sec-4-2)
		-	[4.2.1 単一ワード整数タグ](#sec-4-2-1)
		-	[4.2.2 多倍ワード整数タグ](#sec-4-2-2)
		-	[4.2.3 単一ワード長バイナリタグ](#sec-4-2-3)
		-	[4.2.4 多倍ワード長バイナリタグ](#sec-4-2-4)
		-	[4.2.5 単一ワード長文字列タグ](#sec-4-2-5)
		-	[4.2.6 多倍ワード長文字列タグ](#sec-4-2-6)
		-	[4.2.7 実数型タグ](#sec-4-2-7)
		-	[4.2.8 単一ワード長コレクションタグ](#sec-4-2-8)
		-	[4.2.9 多倍ワード長コレクションタグ](#sec-4-2-9)
		-	[4.2.10 コレクション終端タグ](#sec-4-2-10)
		-	[4.2.11 名前タグ](#sec-4-2-11)
		-	[4.2.12 拡張オブジェクトタグ](#sec-4-2-12)
-	[5 XPOS データフォーマット](#sec-5)
	-	[5.1 プリミティブ型 オブジェクト記述](#sec-5-1)
		-	[5.1.1 整数型 オブジェクト記述](#sec-5-1-1)
		-	[5.1.2 バイナリ型 オブジェクト記述](#sec-5-1-2)
		-	[5.1.3 文字列型 オブジェクト記述](#sec-5-1-3)
		-	[5.1.4 実数型 オブジェクト記述](#sec-5-1-4)
		-	[5.1.5 コレクション型 オブジェクト記述](#sec-5-1-5)
	-	[5.2 マジックナンバー](#sec-5-2)
	-	[5.3 XPOS データ記述](#sec-5-3)
-	[6 仕様の策定者への勧告](#sec-6)
	-	[6.1 オブジェクト配置の規則](#sec-6-1)
	-	[6.2 日付と時間の記述](#sec-6-2)
	-	[6.3 名前の規則](#sec-6-3)
	-	[6.4 拡張オブジェクト型の扱い](#sec-6-4)
	-	[6.5 実数型の扱い](#sec-6-5)
-	[付録A. 拡張オブジェクト使用例: CRCチェックサム](#appendix-a)
	-	[A.1 拡張識別子](#appendix-a-1)
	-	[A.2 チェックサムの計算](#appendix-a-2)
	-	[A.3 オブジェクトの記述](#appendix-a-3)


## <a id="sec-2"></a> 2. Terms and Acronyms - 用語と頭字語

-	**Bit (ビット)** --
	二進数で`0`または`1`で表される量。
	本書では特に断りのない限りビット列を最初のビットから順に"`bbbb...`b"と表記する。

-	**Byte (バイト)** --
	8個のビット列。
	本書では特に断りのない限りバイト列を最初のバイトから順に"`xx xx ...`h"と表記する。

-	**Extended Identifier (拡張識別子)** --
	拡張データ([3.7章](#sec-3-7))において、内容となる拡張データの種類を特定するための4バイトのビット列。

-	**Magic Number (マジックナンバー)** --
	XPOSデータを識別するために先頭に付与されるビット列。

-	**Identifier (識別子)** --
	タグを区別するために用いる1バイトの長さの一意のデータ。

-	**Name (名前)** --
	オブジェクトを一意に識別するために付与する文字列。

-	**Object (オブジェクト)** --
	特定のプリミティブ型によるデータを持つエンティティ。

-	**Primitive Type (プリミティブ型)** --
	データ構造を記述するための最小単位となるデータの型。
	[3章](#sec-3)を参照。

-	**Tag (タグ)** --
	XPOSにおいてオブジェクトを記述するために用いる1ワード以上の大きさを持つデータの集まり。

-	**Word (ワード)** --
	4個のバイトの集まり。
	本書では特に断りのない限りワード列を最初のワードから順に

		xx xx xx xx  xx xx xx xx
		xx xx xx xx  xx xx xx xx
		...

	と表記する。

-	**XPOS** --
	Extensible Primitive-Object Structure の略。


## <a id="sec-3"></a> 3. Primitive Types and Objects - プリミティブ型とオブジェクト

XPOSでは、次の5種類の型をプリミティブ型と総称し、扱うこととする。

-	Integer Type - 整数型
-	Binary Type - バイナリ型
-	String Type - 文字列型
-	Real Number Type - 実数型
-	Collection Type - コレクション型

各プリミティブ型のデータを格納したデータエンティティをオブジェクトと呼ぶ。
原則として、1個のオブジェクトにはちょうど1個のプリミティブ型のデータが含まれていなければならない。
例外はコレクション型のオブジェクトであり、オブジェクト内に複数のオブジェクトを格納することで複数のプリミティブ型データを含めることができる。

また、オブジェクトに付加する情報として、次のデータを持つことができる。

-	Object Name - 名前
-	Extended Object - 拡張オブジェクト

XPOSデータはプリミティブ型データのみですべてのデータを再現できなくてはならない。
つまり、名前や拡張オブジェクトのみで構成されるオブジェクトが存在してはならず、
拡張オブジェクトが削除されても内容を再現できなくてはならないということである。

### <a id="sec-3-1"></a> 3.1. Integer Type - 整数型

整数型は、整数を記述するためのプリミティブ型である。
扱う整数は2の補数による符号付きの整数であり、バイトオーダーはビッグエンディアンである。

整数型は、タグの記述においてそのデータサイズの表現を行う際にも用いられる。

### <a id="sec-3-2"></a> 3.2. Binary Type - バイナリ型

バイナリ型は、0ビット以上の長さのビット列を記述するためのプリミティブ型である。

### <a id="sec-3-3"></a> 3.3. String Type - 文字列型

文字列型は、Unicode文字列を記述するためのプリミティブ型である。
扱う文字列はUTF-8エンコードであり、null文字(\\0)によって終端する必要はない。

内部のデータは正しいUTF-8エンコードのUnicode形式でなければならない。

文字列型は、オブジェクトに含める名前にも用いられる。

### <a id="sec-3-4"></a> 3.4. Real Number Type - 実数型

実数型は、実数を記述するためのプリミティブ型である。
扱う実数は、IEEE-754の浮動小数点数のうち、二進法の基本形式

-	単精度 (binary32)
-	倍精度 (binary64)
-	四倍精度 (binary128)

および交換形式

-	半精度 (binary16)
-	四倍精度以上 (binary160 ...)

のいずれかである。

また、バイトオーダーはビッグエンディアンである。

### <a id="sec-3-5"></a> 3.5. Collection Type - コレクション型

コレクション型は、内部に0個以上のオブジェクトを置くことができるプリミティブ型である。
コレクション型を含むすべてのオブジェクトを配置することができるため、入れ子構造を作成することができる。

コレクション型オブジェクト内のオブジェクトは順序を持ち、通常データ内で現れた順に並ぶ。

### <a id="sec-3-6"></a> 3.6. Object Name - 名前

名前型はオブジェクトの名前を定義するためのデータであり、オブジェクトに1個まで含めることができる。

名前型の内容は文字列型([3.1.3.参照](#sec-3-1-3))と同等である。
文字列型で課される制限に加え、

-	a) 使用可能な文字は制御文字(null文字\\0、改行\\n、タブ\\tなど)や絵文字を除いたUnicode印刷文字、およびスペース(U+0020"SPACE", U+3000"IDEOGRAPHIC SPACE")のみとする
-	b) 名前の先頭・あるいは末尾がスペースであったり、スペースのみで構成されていてはならない
-	c) 最大の長さは65535バイトとする
-	d) 同一のコレクション型のデータ内で名前が重複してはならない

といった制約が課される。

コレクション型オブジェクトなどで複数のオブジェクトを配置する際、それらのうちの一部のみに名前を含めることができる。
すべてのオブジェクトに名前を含める必要はない。

### <a id="sec-3-7"></a> 3.7. Extended Object Type - 拡張オブジェクト

オブジェクトに付随するプライベートデータを記述するための型であり、データの種類を区別するための拡張識別子と、その内容を表すビット列を持つことができる。

この型はデータの再現に必須ではないデータを記述するために用いることができる。例えば、

-	標準仕様に含まれていない機能のために互換性のある標準仕様のデータに追加されるデータ
-	データの再現を行うにあたって、効率化や信頼性向上のために置かれるデータ構造のバイナリ

などが挙げられる。

拡張識別子は32ビットのビット列として扱う。
ASCIIまたはその他の文字としてエンコードできないビット列でもよい。

デコーダはこの型のデータに遭遇した場合、拡張識別子を確認し、対応していないものは読み飛ばしてもよい。
また、デコーダはこの型のいずれのデータも対応する必要はなく、この型に遭遇した場合に無条件で読み飛ばす処理を行ってもよい。

拡張オブジェクト型の内容をコピーすることは基本的に危険であり、XPOSデータの書き出しの際は内容を認識しない拡張オブジェクト型のデータをコピーしてはならない。


## <a id="sec-4"></a> 4. XPOS Tag Format - XPOS タグフォーマット

XPOSデータの本体は1個以上のXPOSタグの羅列によって構成されている。

XPOSタグのデータを構成する単位は4バイトの長さを持つビット列である"ワード"である。
1個以上のワードの内容によって1つのタグを記述する。

### <a id="sec-4-1"></a> 4.1. Tag Internal Structure - タグ内部構造

タグの内部構造は扱うデータの大きさによって3つの種類に分けられる。

-	Single Word Tag - 単一ワードタグ
-	Single Word Length Tag - 単一ワード長タグ
-	Long Word Length Tag - 多倍ワード長タグ

どの内部構造のタグであるかは、そのタグの識別子に依存する。

#### <a id="sec-4-1-1"></a> 4.1.1. Single Word Tag - 単一ワードタグ

単一ワードタグは、タグのデータ長がちょうど1ワードであるタグである。
この場合、最初の1バイトに識別子が入り、その残りの3バイトに実際のデータが記述される。

この構造で扱うことができるデータの長さはちょうど3バイトである。

#### <a id="sec-4-1-2"></a> 4.1.2. Single Word Length Tag - 単一ワード長タグ

単一ワード長タグは、最初のワードにタグのデータ長を記述したタグである。
この場合、最初の1バイトに識別子が入り、その残りの3バイトに整数型([3.1.参照](#sec-3-1))によって実際のデータの長さが記述される。
次のワード以降に実際のデータが記述され、ワード単位でアライメントを行う。
つまり、データの長さ(バイト単位)が正確に4の倍数ではない場合、データの最後にデータの長さが正確に4の倍数となるように`0`bをパディングする。

この構造で扱うことができるデータの長さは 0バイト から 8388607バイト である
(誤解を避けるために記述しておくと、XPOSで用いる整数は常に2の補数による符号付き整数であるため、
3バイトの長さで表すことのできる最大の値は `7F FF FF`h = 8388607 である)。


#### <a id="sec-4-1-3"></a> 4.1.3. Long Word Length Tag - 多倍ワード長タグ

多倍ワード長タグは、2番目のワード以降にタグのデータ長を記述したタグである。
この場合、[4.1.2.](#sec-4-1-2)でデータを記述するかのように実際のデータの長さを整数型([3.1.参照](#sec-3-1))によって記述する。
長さのデータが記述された最後のワードの次のワード以降に実際のデータが記述され、ワード単位でアライメントを行う。
つまり、データの長さ(バイト単位)が正確に4の倍数ではない場合、データの最後にデータの長さが正確に4の倍数となるように`0`bをパディングする。

データの長さを記述する際、その整数のデータはワード境界にアライメントされていなくてはならない。
つまり、"実際のデータの長さを表す整数のデータ"の長さ(すなわち、最初のワードに記述する整数)は常に正確に4の倍数でなければならない。

実際のデータ長を表すための整数に扱うことができる長さは 0バイト から 8388604バイト である。
つまり、この構造で扱うことができるデータの長さは 0バイト から 2.55x10^20201771バイト である。

### <a id="sec-4-2"></a> 4.2. Identifier - 識別子

タグの最初の1バイトには識別子が存在し、すべてのタグの種類とその識別子は一対一で関連付けられている。

エンコードする際、このデータフォーマットで定義されていない識別子を用いてはならない。
また、このデータフォーマットで定義されている識別子を用いてこのデータフォーマットと異なるデータの記述を行ってはならない。

デコードする際、未知の識別子に遭遇した場合、エラーを発してデータの処理を停止しなくてはならない。

#### <a id="sec-4-2-1"></a> 4.2.1. Short Integer Tag - 単一ワード整数タグ

識別子が`69`h (ASCII: "i")であるタグは、単一ワード整数タグを表す。
内容は単一ワードタグ([4.1.1.参照](#sec-4-1-1))として表し、
整数型([3.1.参照](#sec-3-1))によってデータを記述する。

数値25551を単一ワード整数タグで表す場合、タグの内容は次のようになる。

	69 00 63 CF

記述可能な値の範囲は、-8388608(`80 00 00`h)から8388607(`7F FF FF`h)である。

#### <a id="sec-4-2-2"></a> 4.2.2. Long Integer Tag - 多倍ワード整数タグ

識別子が`49`h (ASCII: "I")であるタグは、多倍ワード整数タグを表す。
内容は単一ワード長タグ([4.1.2.参照](#sec-4-1-2))として表し、
整数型([3.1.参照](#sec-3-1))によってデータを記述する。

データはワードの境界にアライメントされていなくてはならない。
つまり、データの長さはちょうど4バイトの倍数でなくてはならないということである。

数値3^3^3(=7625597484987)を多倍ワード整数タグで表す場合、タグの内容は次のようになる。

	49 00 06 4B  00 00 06 EF
	79 07 7F BB

データの長さとして記述可能な値の範囲は4(`00 00 04`h)から8388604(`7F FF FB`h)である
(誤解を避けるために記述しておくと、XPOSで用いる整数は常に2の補数による符号付き整数であるため、
3バイトの長さで表すことのできる最大の値は `7F FF FF`h = 8388607 である)。
これは、最大で 2.55x10^20201771 までの整数を表現することができることを意味する。

#### <a id="sec-4-2-3"></a> 4.2.4. Short Binary Tag - 単一ワード長バイナリタグ

識別子が`62`h (ASCII: "b")であるタグは、単一ワード長バイナリタグを表す。
内容は単一ワード長タグ([4.1.2.参照](#sec-4-1-2))として表し、
バイナリ型([3.2.参照](#sec-3-2))によってデータを記述する。

格納されるデータは単純なビット列として扱い、それらに対して課される制約はない。
これは、複数バイトで組になる値が存在した場合に、XPOSでそれらのバイト順序を制限したり、
ビット列に対してXPOSでワード単位でのアライメントを要求することはないということである。

#### <a id="sec-4-2-4"></a> 4.2.4. Long Binary Tag - 多倍ワード長バイナリタグ

識別子が`42`h (ASCII: "B")であるタグは、多倍ワード長バイナリタグを表す。
内容は多倍ワード長タグ([4.1.3.参照](#sec-4-1-3))として表し、
バイナリ型([3.2.参照](#sec-3-2))によってデータを記述する。

格納されるデータは単純なビット列として扱い、それらに対して課される制約はない。
これは、複数バイトで組になる値が存在した場合に、XPOSでそれらのバイト順序を制限したり、
ビット列に対してXPOSでワード単位でのアライメントを要求することはないということである。

#### <a id="sec-4-2-5"></a> 4.2.5. Short String Tag - 単一ワード長文字列タグ

識別子が`73`h (ASCII: "s")であるタグは、単一ワード長文字列タグを表す。
内容は単一ワード長タグ([4.1.2.参照](#sec-4-1-2))として表し、
文字列型([3.3.参照](#sec-3-3))によってデータを記述する。

文字列"美しい日本語"を単一ワード長文字列で表す場合、タグの内容は次のようになる。

	73 00 00 12  E7 BE 8E E3
	81 97 E3 81  84 E6 97 A5
	E6 9C AC E8  AA 9E 00 00

#### <a id="sec-4-2-6"></a> 4.2.6. Long String Tag - 多倍ワード長文字列タグ

識別子が`53`h (ASCII: "S")であるタグは、多倍ワード長文字列タグを表す。
内容は多倍ワード長タグ([4.1.3.参照](#sec-4-1-3))として表し、
文字列型([3.3.参照](#sec-3-3))によってデータを記述する。

[バベルの図書館の部屋0-棚1-行1-列1の本の内容](http://libraryofbabel.info/book.cgi?0-w1-s1-v01:1)を多倍ワード長文字列タグで表す場合、タグの内容は次のようになる。

	53 00 00 04  00 14 05 00
	65 2C 6B 74  ...
	... (中略)
	61 6A 6A 68

### <a id="sec-4-2-7"></a> 4.2.7. Real Number Tag - 実数型タグ

識別子が`72`h (ASCII: "r")であるタグは、実数型タグを表す。
内容は単一ワード長タグ([4.1.2.参照](#sec-4-1-2))として表し、
実数型([3.4.参照](#sec-3-4))によってデータを記述する。

格納される浮動小数点数の形式はデータの長さの値によって区別される。
つまり、取りうるデータ長の値は

-	2 `00 00 02`h (binary16)
-	4 `00 00 04`h (binary32)
-	8 `00 00 08`h (binary64)
-	16 `00 00 10`h (binary128)

および16以上の4の倍数であり、それ以外の値がデータ長の値として現れてはならないということである。

#### <a id="sec-4-2-8"></a> 4.2.8. Short Collection Tag - 単一ワード長コレクションタグ

識別子が`63`h (ASCII: "c")であるタグは、単一ワード長コレクションタグを表す。
内容は単一ワード長タグ([4.1.2.参照](#sec-4-1-2))として表し、
コレクション型([3.5.参照](#sec-3-5))によってデータを記述する。

2個以上のオブジェクトを記述する場合、直前のオブジェクトの最後のワードの直後にオブジェクトを記述する。
オブジェクトとオブジェクトの間に余分なデータを含めてはならない。

オブジェクトは1ワード(4バイト)にアライメントされているため、コレクション型のデータ長は必ず4の倍数に等しくなる。

#### <a id="sec-4-2-9"></a> 4.2.9. Long Collection Tag - 多倍ワード長コレクションタグ

識別子が`43`h (ASCII: "C")であるタグは、多倍ワード長コレクションタグを表す。
内容は多倍ワード長タグ([4.1.3.参照](#sec-4-1-3))として表し、
コレクション型([3.5.参照](#sec-3-5))によってデータを記述する。

2個以上のオブジェクトを記述する場合、直前のオブジェクトの最後のワードの直後にオブジェクトを記述する。
オブジェクトとオブジェクトの間に余分なデータを含めてはならない。

オブジェクトは1ワード(4バイト)にアライメントされているため、コレクション型のデータ長は必ず4の倍数に等しくなる。

#### <a id="sec-4-2-10"></a> 4.2.10. Collection Termination Tag - コレクション終端タグ

識別子が`2E`h (ASCII: ".")であるタグは、コレクション終端タグを表す。
内容は単一ワードタグ([4.1.1.参照](#sec-4-1-1))として表し、
データの本体部分は空とする(`0`b でフィルする)。

### <a id="sec-4-2-11"></a> 4.2.11. Name Tag - 名前タグ

識別子が`4E`h (ASCII: "N")であるタグは、名前タグを表す。
内容は単一ワード長タグ([4.1.2.参照](#sec-4-1-2))として表し、
名前([3.6.参照](#sec-3-6))によってデータを記述する。

### <a id="sec-4-2-12"></a> 4.2.12. Extended Object Tag - 拡張オブジェクトタグ

識別子が`78`h (ASCII: "x")であるタグは、拡張オブジェクトタグを表す。
内容は単一ワード長タグ([4.1.2.参照](#sec-4-1-2))として表し、
拡張オブジェクト([3.7.参照](#sec-3-7))によってデータを記述する。

また、拡張識別子は必ず拡張オブジェクト内に存在する必要があるため、データ長は必ず4以上となる。


## <a id="sec-5"></a> 5. XPOS Data Format - XPOS データフォーマット

### <a id="sec-5-1"></a> 5.1. Primitive Type Object Notation - プリミティブ型 オブジェクト記述

プリミティブ型オブジェクトは本体となる部分に格納する型に対応するタグを記述することで表現する。
本体部分は必須であり、必ず1個以上のタグを記述しなければならない。
本体部分となるタグの存在しないオブジェクトは、エラーである。
また、異なる型で使用されるタグを同一オブジェクトに混在させてはならない
(これは通常異なるオブジェクトとして認識されることになる)。
対応するタグとその記述方法は後述する。

プリミティブ型オブジェクトには0個、または1個の名前を含めることができる。
名前はオブジェクト本体部分の前に0個または1個の名前タグ([4.2.11.参照](#sec-4-2-11))を記述することで表現する。

また、プリミティブ型オブジェクトには0個以上の拡張オブジェクトを含めることができる。
拡張オブジェクトはオブジェクト本体部分の後に拡張オブジェクトタグ([4.2.12.参照](#sec-4-2-12))を記述することで表現する。

#### <a id="sec-5-1-1"></a> 5.1.1. Integer Type Object Notation - 整数型 オブジェクト記述

整数型オブジェクトは本体部分に次のタグのいずれかをちょうど1つ持つオブジェクトである。

-	単一ワード整数タグ([4.2.1.参照](#sec-4-2-1))
-	多倍ワード整数タグ([4.2.2.参照](#sec-4-2-2))

通常、使用するタグはその値を表現できる最も小さなタグを用いるべきである。
つまり、格納する値が -8388608 以上 8388607 以下である場合は単一ワード整数タグを使うべきである。

#### <a id="sec-5-1-2"></a> 5.1.2. Binary Type Object Notation - バイナリ型 オブジェクト記述

バイナリ型オブジェクトは本体部分に次のタグのいずれかをちょうど1つ持つオブジェクトである。

-	単一ワード長バイナリタグ([4.2.3.参照](#sec-4-2-3))
-	多倍ワード長バイナリタグ([4.2.4.参照](#sec-4-2-4))

通常、使用するタグはその値を表現できる最も小さなタグを用いるべきである。
つまり、格納するデータの大きさが 8388607 バイト以下である場合は単一ワード長バイナリタグを使うべきである。

#### <a id="sec-5-1-3"></a> 5.1.3. String Type Object Notation - 文字列型 オブジェクト記述

文字列型オブジェクトは本体部分に次のタグのいずれかをちょうど1つ持つオブジェクトである。

-	単一ワード長文字列タグ([4.2.5.参照](#sec-4-2-5))
-	多倍ワード長文字列タグ([4.2.6.参照](#sec-4-2-6))

通常、使用するタグはその値を表現できる最も小さなタグを用いるべきである。
つまり、格納するデータの大きさが 8388607 バイト以下である場合は単一ワード長文字列タグを使うべきである。

#### <a id="sec-5-1-4"></a> 5.1.4. Real Number Type Object Notation - 実数型 オブジェクト記述

実数型オブジェクトは本体部分に実数型タグ([4.2.7.参照](#sec-4-2-7))をちょうど1つ持つオブジェクトである。

#### <a id="sec-5-1-5"></a> 5.1.5. Collection Type Object Notation - コレクション型 オブジェクト記述

コレクション型オブジェクトの本体部分はちょうど2個のタグによって表されるオブジェクトである。
まず、次のタグのいずれかをちょうど1つ持つ。

-	単一ワード長コレクションタグ([4.2.8.参照](#sec-4-2-8))
-	多倍ワード長コレクションタグ([4.2.9.参照](#sec-4-2-9))

また、その直後にコレクション終端タグ([4.2.10.参照](#sec-4-2-10))をちょうど1つ持つ。

どちらのタグも必須であり、どちらかのタグのないオブジェクトは、エラーである。

また、単一ワード長コレクションタグ、または多倍ワード長コレクションタグと、
コレクション終端タグの間にはいかなるタグも含まれてはならない。
誤解を避けるために記述すると、単一ワード長コレクションタグ、または多倍ワード長コレクションタグの内容として記述される
タグやオブジェクトにはこの制限は適用されない。
あくまで、単一ワード長コレクションタグ、または多倍ワード長コレクションタグの内容に含まれないタグが現れてはならない、ということである。

通常、使用するタグはその値を表現できる最も小さなタグを用いるべきである。
つまり、格納するデータの大きさが 8388604 バイト以下である場合は単一ワード長コレクションタグを使うべきである。

### <a id="sec-5-2"></a> 5.2. Magic Number - マジックナンバー

通常、XPOSデータはその内容がXPOSデータフォーマットで記述されていることを識別できるようにするために、
データの先頭にちょうどひとつのマジックナンバーを置く必要がある。

XPOSデータのマジックナンバーは2ワードの長さの固定のビット列であり、その内容は

	80 00 FF 00  58 50 4F 53

である。

XPOSデータを読み込む場合、原則として最初の2ワードを読み込み、
マジックナンバーが一致していることを確認しなければならない。

例外として、外部のフォーマットなどでXPOSデータを含む際、XPOSデータ以外のデータが記述されることがなく、
XPOSデータであるかを検証する必要がないとわかっている場合にはマジックナンバーを含めないよう仕様を策定してもよい。
そのような仕様が明示的に記載されている場合はマジックナンバーを置いてはならない。

### <a id="sec-5-3"></a> 5.3. XPOS Data Notation - XPOS データ記述

XPOSデータを記述するには、まず(必要な場合)最初の2ワードでマジックナンバーを記述し、
続いてオブジェクトをちょうど一つだけ記述する。
ここに記述したちょうど一つのオブジェクトがXPOSデータにおけるオブジェクトツリーのルートとなる。

オブジェクトは必須であり、0個以下であっても2個以上であってもならないが、記述するオブジェクトはいずれでもよい。

誤解を避けるために記述すると、オブジェクトツリーのルートにコレクション型を記述する場合、その内部に記述するオブジェクトの数にこの制限は適用されない。
つまり、XPOSデータに2個以上のデータを記述する場合、そのデータのルートは常にコレクション型となる。

ルートオブジェクトに名前をつけてもよい。

ルートオブジェクトの最後のワード以降のデータはすべて無視するものとする。
これは、ルートとなるオブジェクトに拡張オブジェクトを付加することはできるが、
それらがデコーダによって検出されない可能性があることを意味する。


## <a id="sec-6"></a> 6. Recommendation for Formulator - 仕様の策定者への勧告

この章は、XPOSデータフォーマットを用いた仕様を策定するにあたっての推奨を示すものである。

### <a id="sec-6-1"></a> 6.1. Object Placement Rules - オブジェクト配置の規則

オブジェクトはプリミティブ型で表現できる場合、可能な限りプリミティブ型データとして配置するべきである。
プリミティブ型で表現可能な何らかのデータ構造をバイナリとしてバイナリ型に格納することは移植性の低下につながることから、推奨しない。

例外として、同一データ型の大規模な配列や、圧縮されたデータを扱う場合は空間効率のためにもバイナリ型で記述したほうがよい。

データ構造をコレクション型に記述する場合、名前によってオブジェクトを識別する方法とデータの出現位置によってオブジェクトを識別する方法の二通りがあるが、そのどちらを用いるかは策定者の自由とする。

### <a id="sec-6-2"></a> 6.2. Date and Time Notation - 日付と時間の記述

日付、および時間をXPOSデータに記述する場合は、特定の時刻からの経過時間として整数型を用いて記述することを推奨する。

日付・時刻の記述に文字列型を用いた場合、ロケール等によって多様に変化するフォーマットに対応せねばならず、パーサーだけで大きなフットプリントを必要とするため、
また、整数型を用いたほうが日付・時刻の表現に必要なデータの大きさが通常小さく済むためである。

他にも、ユリウス日からの日数を実数で記述する方法も存在するが、XPOSで使用する浮動小数点数の記述では時刻によって精度が大きく変化するため、推奨しない。

日付、時刻の記述にあたって基準とする時刻、およびその経過時間を表すための時間の刻み幅はその仕様の策定者の自由とする。

### <a id="sec-6-3"></a> 6.3. Name Rules - 名前の規則

オブジェクトに付加する名前には移植性を維持するためにも、ASCIIで表現可能な英大小文字、数字およびアンダーバーなど、オブジェクトの名前として慣用的に用いられている文字のみで構成された文字列を用いることを推奨する。
特に、オブジェクト階層の区切り文字として慣用的に用いられる文字(e.g. `/`, `\`, `.`, `:`)やクォート文字(e.g. `"`, `'`, `` ` ``)を用いることは避けるべきである。

ルートオブジェクトの名前にはそのフォーマットの名前を記述することを推奨する。
これにより、ルートオブジェクトの名前を参照することでどのようなデータが格納されているかの参考にすることができるからである。

### <a id="sec-6-4"></a> 6.4. Handling of Extended Object Type - 拡張オブジェクト型の扱い

拡張オブジェクトはデータの再現に必ずしも必要ではないデータを、オブジェクトに付加する形式で記述するデータである。
例えば、三次元空間の座標を表すオブジェクトをXPOSで表現する場合、各座標軸の値をプリミティブ型で表現しなければならないが、それらから算出できるゼロ点からの距離や偏角は拡張オブジェクトに格納してよいということである。
これらの拡張オブジェクトをどのように扱う(扱わせる)かは、策定者の自由とする。
つまり、拡張オブジェクトに格納できるデータを必ず格納するように仕様を策定することも、特定の拡張オブジェクトの読み込みを実装者に必ず行わせるよう使用を策定することも、策定者の自由である。

### <a id="sec-6-5"></a> 6.5. Real Number Type - 実数型の扱い

実数型でオブジェクトを記述する場合において、どの形式によってオブジェクトを記述する(させる)かは策定者の自由である。
ただし、多くの場合ほとんどの実行環境でそのまま扱うことのできる32ビットまたは64ビットの基本形式が推奨される。


## <a id="appendix-a"></a> 付録A. Example of Extended Object: CRC Checksum - 拡張オブジェクト使用例: CRCチェックサム

ここでは拡張オブジェクトの使用例として、プリミティブ型オブジェクトの検証を行うCRCチェックサムのオブジェクトを定義する。

### <a id="appendix-a-1"></a> A.1. Extend Identifier - 拡張識別子

拡張オブジェクトに付加する拡張識別子は `43 33 32 63`h とする。

### <a id="appendix-a-2"></a> A.2. Checksum Calculation - チェックサムの計算

チェックサムに用いるアルゴリズムはCRC-32Cと呼ばれている巡回冗長検査を用いる。
CRC-32Cの生成多項式は`x32 + x28 + x27 + x26 + x25 + x23 + x22 + x20 + x19 + x18 + x14 + x13 + x11 + x10 + x9 + x8 + x6 + 1`である。

このアルゴリズムを関連付けられているプリミティブ型オブジェクトの最初のワードから最後のワードまでに対して行う。
名前や他の拡張オブジェクトのオブジェクトはチェックサムの計算に含めない。
これによってこの拡張オブジェクトに格納するチェックサムの値を導出する。

### <a id="appendix-a-3"></a> A.3. Object Notation - オブジェクトの記述

このオブジェクトの大きさは常に固定の長さ(8バイト)である。
つまり、最初のワードは `78 00 00 08`h で固定となる。

この拡張オブジェクトの内容は次のようになる。

-	拡張オブジェクトのヘッダ(`78 00 00 08`h)
-	拡張識別子(`43 33 32 63`h)
-	チェックサムの値(符号なし32ビット整数、ビッグエンディアン)

チェックサムの値が `DE AD BE EF`h であった場合、実際に記述されるオブジェクトの内容は次のようになる。

	78 00 00 08  43 33 32 63
	DE AD BE EF

